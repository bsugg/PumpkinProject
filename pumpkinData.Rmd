---
title: "ST542 - Consulting Project"
author: "Brian Sugg & Chengxi Zou"
date: "1/26/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(formatR)
library(dplyr)
library(readxl)
library(ggplot2)
library(writexl)
knitr::opts_chunk$set(echo=TRUE,tidy.opts=list(width.cutoff=70),tidy=TRUE)
```

# Import Data  

## Import Spacing Data from 2020  

Check workbook names and worksheet names for each of the 3 read_excel functions.  
Check columns to gather and ensure in Excel the columns with metrics are 8 to 55.  
Adjust both the year and pumpkin ID variables to reflect year 2020.  

```{r readExcel2020}
# Read sheet with WEIGHTS, transform from wide to tall, remove NA records
spacingWeight <- read_excel(path="2020pumpkinData.xlsx", sheet="Spacing Weight")
spacingWeight <- gather(spacingWeight,key="Pumpkin",value="Weight",8:55)
spacingWeight <- subset(spacingWeight,!is.na(Weight))
# Rename columns
names(spacingWeight) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","weight")
# Create unique identifier for each pumpkin
spacingWeight <- mutate(spacingWeight,pumpkinID=paste0("2020S","-",plot,"-",pumpkinNum))
spacingWeight <- mutate(spacingWeight,year="2020")

# Read sheet with LENGTHS, transform from wide to tall, remove NA records
spacingLength <- read_excel(path="2020pumpkinData.xlsx", sheet="Spacing Length")
spacingLength <- gather(spacingLength,key="Pumpkin",value="Length",8:54)
spacingLength <- subset(spacingLength,!is.na(Length))
# Rename columns
names(spacingLength) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","length")
# Create unique identifier for each pumpkin and assign crop year
spacingLength <- mutate(spacingLength,pumpkinID=paste0("2020S","-",plot,"-",pumpkinNum))
spacingLength <- mutate(spacingLength,year="2020")

# Read sheet with DIAMETERS, transform from wide to tall, remove NA records
spacingDiameter <- read_excel(path="2020pumpkinData.xlsx", sheet="Spacing Diameter")
spacingDiameter <- gather(spacingDiameter,key="Pumpkin",value="Diameter",8:54)
spacingDiameter <- subset(spacingDiameter,!is.na(Diameter))
# Rename columns
names(spacingDiameter) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","diameter")
# Create unique identifier for each pumpkin and assign crop year
spacingDiameter <- mutate(spacingDiameter,pumpkinID=paste0("2020S","-",plot,"-",pumpkinNum))
spacingDiameter <- mutate(spacingDiameter,year="2020")

# Join all spacing metrics in one raw table for quality checks
spacingDataRaw2020 <- inner_join(spacingWeight,spacingLength)
spacingDataRaw2020 <- inner_join(spacingDataRaw2020,spacingDiameter)

# Create clean table for further transformations
spacingData2020 <- as_tibble(spacingDataRaw2020)

# Remove bad pumpkins ... NEED TO CONFIRM WITH CLIENT
spacingData2020 <- subset(spacingData2020, weight!="rotten")
```  

## Import Spacing Data from 2021  

Check workbook names and worksheet names for each of the 3 read_excel functions.  

```{r readExcel2021}
# Read sheet with WEIGHTS, transform from wide to tall, remove NA records
spacingWeight <- read_excel(path="2021pumpkinData.xlsx", sheet="Spacing Weights (lbs)")
spacingWeight <- gather(spacingWeight,key="Pumpkin",value="Weight",8:55)
spacingWeight <- subset(spacingWeight,!is.na(Weight))
# Rename columns
names(spacingWeight) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","weight")
# Create unique identifier for each pumpkin
spacingWeight <- mutate(spacingWeight,pumpkinID=paste0("2021S","-",plot,"-",pumpkinNum))
spacingWeight <- mutate(spacingWeight,year="2021")

# Read sheet with LENGTHS, transform from wide to tall, remove NA records
spacingLength <- read_excel(path="2021pumpkinData.xlsx", sheet="Spacing Lengths (inches)")
spacingLength <- gather(spacingLength,key="Pumpkin",value="Length",8:55)
spacingLength <- subset(spacingLength,!is.na(Length))
# Rename columns
names(spacingLength) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","length")
# Create unique identifier for each pumpkin and assign crop year
spacingLength <- mutate(spacingLength,pumpkinID=paste0("2021S","-",plot,"-",pumpkinNum))
spacingLength <- mutate(spacingLength,year="2021")

# Read sheet with DIAMETERS, transform from wide to tall, remove NA records
spacingDiameter <- read_excel(path="2021pumpkinData.xlsx", sheet="Spacing Diameters (inches)")
spacingDiameter <- gather(spacingDiameter,key="Pumpkin",value="Diameter",8:55)
spacingDiameter <- subset(spacingDiameter,!is.na(Diameter))
# Rename columns
names(spacingDiameter) <- c("plot","treatment","rep","standCount","standCountIdeal","spacingDim","greenPumpkins","pumpkinNum","diameter")
# Create unique identifier for each pumpkin and assign crop year
spacingDiameter <- mutate(spacingDiameter,pumpkinID=paste0("2021S","-",plot,"-",pumpkinNum))
spacingDiameter <- mutate(spacingDiameter,year="2021")

# Join all spacing metrics in one raw table for quality checks
spacingDataRaw2021 <- inner_join(spacingWeight,spacingLength)
spacingDataRaw2021 <- inner_join(spacingDataRaw2021,spacingDiameter)

# Create clean table for further transformations
spacingData2021 <- as_tibble(spacingDataRaw2021)
```  

# Transform Data  

```{r transformData}
# Stack the 2020 and 2021 data sets into one tibble
spacingData <- rbind(spacingData2020,spacingData2021)

# Format variables
spacingData$plot <- as.factor(spacingData$plot)
spacingData$treatment <- as.factor(spacingData$treatment)
spacingData$rep <- as.factor(spacingData$rep)
spacingData$pumpkinNum <- as.numeric(spacingData$pumpkinNum)
spacingData$year <- as.factor(spacingData$year)

# Create variable for pumpkin color, populate based on conditional statement, and format
spacingData <- mutate(spacingData,color="unknown")
for (i in 1:nrow(spacingData)) {
  spacingData[i,14] <- if_else(spacingData[i,8] %in% sapply(strsplit(as.character(spacingData[i,7]),split=", "),function(x) as.numeric(x)),
                                 "Green",
                                 "Orange")
}
spacingData$color <- as.factor(spacingData$color)

# Create variable for spacing area and transform spacing variables factors
spacingData <- mutate(spacingData,spacingArea=sapply(strsplit(as.character(spacingDim),split=" x "),function(x) prod(as.numeric(x))))
spacingData$spacingArea <- as.factor(spacingData$spacingArea)
spacingData$spacingDim <- as.character(spacingData$spacingDim)
spacingData$length <- as.numeric(spacingData$length)

# Create variable for realized ideal stand count percentage
spacingData <- mutate(spacingData,standCountIdealPct=standCount/standCountIdeal)

# Arrange columns for presentation of final table for spacing data
spacingData <- select(spacingData,c(11,10,1,3,2,8,15,6,4,5,16,14,9,12,13))

# Split spacingDim for betweenRow and inRow columns
spacingData <- separate(spacingData,spacingDim,into = c("betweenRow","inRow"),sep=" x ",remove=FALSE)
spacingData$spacingDim <- as.factor(spacingData$spacingDim)
spacingData$betweenRow <- as.numeric(spacingData$betweenRow)
spacingData$inRow <- as.numeric(spacingData$inRow)

# Provide structure of transformed variables with data preview
str(spacingData)
spacingData

# Export R data object to Excel for client review
write_xlsx(spacingData,"spacingData.xlsx")
```

# Explore Data  

```{r exploreData}
# Scatter plot of weight vs length
plot(spacingData$length,spacingData$weight,
     xlab="Diameter (in)",
     ylab="Weight (lbs)")

# Scatter plot of weight vs diameter
plot(spacingData$diameter,spacingData$weight,
     xlab="Length (in)",
     ylab="Weight (lbs)")

# Scatter plot of diameter vs length
plot(spacingData$length,spacingData$diameter,
     xlab="Length (in)",
     ylab="Diameter (in)")

# Boxplot by spacing dimension
ggplot(spacingData, aes(x=spacingDim, y=weight, fill=spacingDim)) +
    geom_boxplot(varwidth = TRUE, alpha=0.2) +
    theme(legend.position="none")

# Boxplot by spacing area
ggplot(spacingData, aes(x=spacingArea, y=weight, fill=spacingArea)) +
    geom_boxplot(varwidth = TRUE, alpha=0.2) +
    theme(legend.position="none")
```


